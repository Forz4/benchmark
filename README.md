# benchmark-联机交易压力测试工具

## 设计要素说明

1. **通讯连接方式**为TCP异步单工长链接模式。

2. **进程结构**采用一个父进程和一个子进程，父进程负责发送，子进程负责接收。

3. 发送时，父进程从多个socket中**轮询**获取一个用于发送报文。

4. 接收时，子进程采用**select模型**获取可读socket进行接收。

5. 交易来源可从**文件读取**或者从**标准输入**读取，从文件读入时将循环读取文件内容。

6. **日志输出**均写到标准输出`stdout`。

7. 请求和响应报文格式为：**4字节的报文长度+报文体**，请求报文之间以Unix换行符`\n`间隔，十六进制输入模式下，则先将原始报文按照`%02x`方式读入，并转换为Ascii码后再按照报文格式解析。

8. 接收进程**监听建链超时时间**和接收进程**报文接收超时时间**均为20秒。

9. **发送速度控制**：工具将1秒时间均分为N份，则每一段时间`t=1000000/N`微妙，在每一个`t`微妙的时间段内，工具按照`-p选项`指定的时间间隔连续发送`tps/N`笔交易，然后调用`sleep`休眠至`t`微妙，如此能保证2点：

   - 在1秒时间内保证发生`tps`笔交易，从而控制住了tps
   - 交易在1秒内不至于分布不均匀

   目前N在代码中写死为5，报文发送时间间隔在未通过`-p`指定时为10微妙，发送速度`tps`将对5进行取整。

## 选项参数说明

| 选项 | 参数             | 功能                                                         |
| ---- | ---------------- | ------------------------------------------------------------ |
| `-h` |                  | 打印帮助信息                                                 |
| `-f` | filename         | 用于指定交易来源文件，未使用`-f`参数时，默认从标准输入`stdin`读入报文 |
| `-H` |                  | 用于指定十六进制方式读入，未使用`-H`参数时，默认采用Ascii码方式读入 |
| `-i` | IP               | 用于指定远端IP地址，未使用`-i`参数时，默认使用`127.0.0.1`    |
| `-r` | port1,port2, ... | 用于指定远端端口，使用逗号分隔                               |
| `-l` | port1,port2, ... | 用于指定本地监听端口，使用逗号分隔                           |
| `-s` | tps              | 用于指定发送速度（笔数/秒），默认值为10，所输入数字将会向5进行取整 |
| `-t` | time             | 用于指定总发送时间，合法区间为[0,999999]，0表示不限时        |
| `-u` | log\_level        | 用于指定日志级别，合法区间为[0,6]，默认值为4(LOGINF)，值越大打印内容越多 |
| -p   | interval         | 用于设置报文发送时间间隔，合法区间为[0,100]，单位是微妙，默认值为10 |

## 工具使用范例

```shell
# 交易来源为文件111.txt,从本地8888端口发送到本地8888端口，tps=10，时间为30秒
./benchmark -l 8888 -r 8888 -f 111.txt -t 30 -s 10

# 由脚本send.sh产生报文，设置读入的模式为十六进制，输出到文件log.txt，日志级别为6-LOGDBG
./send.sh | ./benchmark -l 8888,8889 -r 8888,8889 -t 10 -s 10 -H -u 6 > log.txt

# 发送123.txt中的报文到远端192.168.1.1的1234端口，监听本地5678端口，不打印日志，不限制发送时间
cat 123.txt | ./benchmark -i 192.168.1.1 -r 1234 -l 5678 -t 0 -s 1000 -u 0
```

## 请求报文范例

```shell
#Ascii码模式:
00041234
0005abcde
#十六进制模式:
3030303431323334
303030356162636465
```

